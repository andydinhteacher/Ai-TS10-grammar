<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Master AI - Tuyển Sinh 10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="text-slate-200 antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI, Type } from '@google/genai';
        import { BookOpen, Play, Sparkles, Key, Check, AlertCircle, Loader2, BrainCircuit, CheckCircle, XCircle, Home, Flag, Trophy, RotateCcw, List, CheckCircle2 } from 'lucide-react';

        // --- TYPES ---
        interface Question {
            question: string;
            options: string[];
            answer: string;
            feedback: string;
        }

        interface UserAnswer {
            questionText: string;
            options: string[];
            selectedOptionLetter: string;
            correctOptionLetter: string;
            isCorrect: boolean;
            feedback: string;
            reported: boolean;
        }

        interface FeedbackState {
            isCorrect: boolean;
            selected: string;
            message: string;
        }

        enum GameState {
            START = 'start',
            LOADING = 'loading',
            QUIZ = 'quiz',
            RESULTS = 'results'
        }

        interface GenerateQuestionsResponse {
            questions: Question[];
        }

        // --- CONSTANTS ---
        const GRAMMAR_TOPICS = {
            "Mixed Practice": "A mix of all grammar topics for a comprehensive review",
            "Tenses": "All verb tenses (present, past, future simple, continuous, perfect)",
            "Modal Verbs": "Modal verbs like can, could, should, must, may, might",
            "Verb Forms": "Gerunds (V-ing) and To-Infinitives (to + V)",
            "Comparisons": "Comparative and Superlative of adjectives and adverbs",
            "Conditional Sentences": "Conditional sentences types 1 and 2, and 'Unless'",
            "Wish Clauses": "Wish clauses for present/future",
            "Relative Clauses": "Relative clauses with who, which, that, whose, where, when, why",
            "Adverbial Clauses": "Adverbial clauses of reason, concession, purpose, result, and time",
            "Reported Speech": "Reported speech for statements, questions, and commands",
            "Adjectives and Adverbs": "Position, function, and order of adjectives and adverbs",
            "Nouns & Articles": "Countable/uncountable nouns, articles (a, an, the), and quantifiers",
            "Prepositions": "Prepositions of time and place",
            "Phrasal Verbs": "Common phrasal verbs found in Grade 10 exams",
        };

        const QUESTION_COUNTS = [5, 10, 15, 20];

        // --- SERVICE ---
        const verifyApiKey = async (apiKey) => {
            if (!apiKey) return false;
            const ai = new GoogleGenAI({ apiKey });
            try {
                await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: { role: "user", parts: [{ text: "Hello" }] },
                });
                return true;
            } catch (error) {
                console.error("API Key verification failed:", error);
                return false;
            }
        };

        const generateQuizQuestions = async (topic, count, apiKey) => {
            if (!apiKey) throw new Error("API Key is required.");
            const ai = new GoogleGenAI({ apiKey });
            const detailedTopic = GRAMMAR_TOPICS[topic];
            
            const prompt = `
                Generate ${count} MCQs for a Vietnamese Grade 10 entrance exam student. 
                The specific grammar topic is: "${topic} - ${detailedTopic}".

                **Requirements:**
                1. Difficulty Distribution: Nhận biết (40%), Thông hiểu (35%), Vận dụng (20%), Vận dụng cao (5%).
                2. Shuffle the questions randomly.
                3. Provide exactly 4 options for each question.
                4. The 'answer' field must be the letter of the correct option (A, B, C, or D).
                5. The 'feedback' must be a concise explanation in Vietnamese explaining why the answer is correct.

                Output strictly in JSON format matching the schema.
            `;

            try {
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: prompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                questions: {
                                    type: Type.ARRAY,
                                    items: {
                                        type: Type.OBJECT,
                                        properties: {
                                            question: { type: Type.STRING },
                                            options: { type: Type.ARRAY, items: { type: Type.STRING } },
                                            answer: { type: Type.STRING, description: "A, B, C, or D" },
                                            feedback: { type: Type.STRING, description: "Vietnamese explanation" }
                                        },
                                        required: ["question", "options", "answer", "feedback"]
                                    }
                                }
                            },
                            required: ["questions"]
                        }
                    }
                });

                let text = response.text || "";
                // Clean markdown if present
                text = text.replace(/^```json\s*/, "").replace(/^```\s*/, "").replace(/\s*```$/, "");
                return JSON.parse(text);
            } catch (error) {
                console.error("Error generating questions:", error);
                throw new Error("Failed to generate questions. Please check your API Key.");
            }
        };

        // --- COMPONENTS ---

        const StartScreen = ({ onStart, error }) => {
            const [selectedTopic, setSelectedTopic] = useState(Object.keys(GRAMMAR_TOPICS)[0]);
            const [questionCount, setQuestionCount] = useState(10);
            const [apiKey, setApiKey] = useState('');
            const [verifying, setVerifying] = useState(false);
            const [keyStatus, setKeyStatus] = useState('idle');

            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) setApiKey(savedKey);
            }, []);

            const handleVerify = async () => {
                if (!apiKey.trim()) return;
                setVerifying(true);
                setKeyStatus('idle');
                const isValid = await verifyApiKey(apiKey);
                setVerifying(false);
                setKeyStatus(isValid ? 'valid' : 'invalid');
                if (isValid) localStorage.setItem('gemini_api_key', apiKey);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!apiKey.trim()) {
                    alert("Please enter your Gemini API Key.");
                    return;
                }
                if (keyStatus !== 'valid') {
                    setVerifying(true);
                    const isValid = await verifyApiKey(apiKey);
                    setVerifying(false);
                    setKeyStatus(isValid ? 'valid' : 'invalid');
                    if (!isValid) return;
                    localStorage.setItem('gemini_api_key', apiKey);
                }
                onStart(selectedTopic, questionCount, apiKey);
            };

            return (
                <div className="w-full max-w-2xl mx-auto bg-slate-800/50 border border-slate-700 p-6 md:p-8 rounded-2xl shadow-xl backdrop-blur-sm animate-fade-in">
                    <div className="text-center mb-8">
                        <div className="bg-cyan-500/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <BookOpen className="w-8 h-8 text-cyan-400" />
                        </div>
                        <h2 className="text-3xl font-bold text-white mb-2">Cấu Hình Bài Luyện</h2>
                        <p className="text-slate-400">Chọn chủ đề và số lượng câu hỏi để bắt đầu</p>
                    </div>

                    {error && (
                        <div className="mb-6 p-4 bg-red-500/10 border border-red-500/50 rounded-lg flex items-start gap-3 text-red-300">
                            <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                            <p>{error}</p>
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div>
                            <label className="block text-slate-300 font-medium mb-2 flex items-center gap-2">
                                <Key className="w-4 h-4 text-yellow-400" /> Gemini API Key
                            </label>
                            <div className="relative flex gap-2">
                                <div className="relative flex-1">
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) => { setApiKey(e.target.value); setKeyStatus('idle'); }}
                                        placeholder="Paste your Gemini API Key here..."
                                        className={`w-full bg-slate-900/80 border rounded-lg py-3 pl-4 pr-10 text-white focus:ring-2 transition-all placeholder-slate-600 ${
                                            keyStatus === 'valid' ? 'border-green-500 focus:ring-green-500' :
                                            keyStatus === 'invalid' ? 'border-red-500 focus:ring-red-500' :
                                            'border-slate-600 focus:ring-yellow-500 focus:border-transparent'
                                        }`}
                                    />
                                    {keyStatus === 'valid' && (
                                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <Check className="w-5 h-5 text-green-500" />
                                        </div>
                                    )}
                                </div>
                                <button
                                    type="button"
                                    onClick={handleVerify}
                                    disabled={verifying || !apiKey}
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed text-slate-200 rounded-lg border border-slate-600 font-medium transition-colors min-w-[80px] flex items-center justify-center"
                                >
                                    {verifying ? <Loader2 className="w-5 h-5 animate-spin" /> : "Verify"}
                                </button>
                            </div>
                            {keyStatus === 'invalid' && (
                                <p className="text-xs text-red-400 mt-2 flex items-center gap-1">
                                    <AlertCircle className="w-3 h-3" /> Key không hợp lệ hoặc không có quyền truy cập.
                                </p>
                            )}
                            <p className="text-xs text-slate-500 mt-2">
                                Get a key at <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-cyan-400 hover:underline">Google AI Studio</a>.
                            </p>
                        </div>

                        <div>
                            <label className="block text-slate-300 font-medium mb-2">Chủ Điểm Ngữ Pháp</label>
                            <div className="relative">
                                <select
                                    value={selectedTopic}
                                    onChange={(e) => setSelectedTopic(e.target.value)}
                                    className="w-full bg-slate-900/80 border border-slate-600 text-white rounded-lg py-3 px-4 appearance-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                >
                                    {Object.keys(GRAMMAR_TOPICS).map((topic) => (
                                        <option key={topic} value={topic}>
                                            {topic === 'Mixed Practice' ? '⚡ Mixed Practice (Tổng hợp)' : topic}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div>
                            <label className="block text-slate-300 font-medium mb-2">Số Lượng Câu Hỏi</label>
                            <div className="grid grid-cols-4 gap-3">
                                {QUESTION_COUNTS.map((count) => (
                                    <button
                                        key={count}
                                        type="button"
                                        onClick={() => setQuestionCount(count)}
                                        className={`py-2 rounded-lg font-medium transition-all duration-200 ${
                                            questionCount === count
                                                ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-500/30 scale-105'
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                    >
                                        {count}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <button
                            type="submit"
                            disabled={verifying}
                            className="w-full mt-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-cyan-500/20 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2 group disabled:opacity-70 disabled:cursor-not-allowed"
                        >
                            <Sparkles className="w-5 h-5 group-hover:animate-pulse" />
                            <span>{verifying ? 'Đang Kiểm Tra...' : 'Bắt Đầu Luyện Tập'}</span>
                            {!verifying && <Play className="w-5 h-5 fill-current" />}
                        </button>
                    </form>
                    <div className="mt-6 text-center text-xs text-slate-500">
                        Powered by Google Gemini 2.5 Flash
                    </div>
                </div>
            );
        };

        const LoadingScreen = () => (
            <div className="w-full max-w-2xl mx-auto bg-slate-800/50 border border-slate-700 rounded-2xl p-12 text-center shadow-xl backdrop-blur-sm flex flex-col items-center justify-center min-h-[400px] animate-fade-in">
                <div className="relative mb-6">
                    <div className="absolute inset-0 bg-cyan-500 blur-xl opacity-20 rounded-full animate-pulse"></div>
                    <BrainCircuit className="w-16 h-16 text-cyan-400 animate-pulse relative z-10" />
                </div>
                <h2 className="text-2xl font-bold text-white mb-2">AI Đang Soạn Đề...</h2>
                <p className="text-slate-400 mb-8 max-w-sm mx-auto">Hệ thống đang phân tích chủ đề và tạo ra các câu hỏi phù hợp với trình độ tuyển sinh lớp 10.</p>
                <div className="flex items-center gap-2 text-cyan-400 bg-cyan-950/30 px-4 py-2 rounded-full border border-cyan-900">
                    <Loader2 className="w-4 h-4 animate-spin" />
                    <span className="text-sm font-medium">Processing with Gemini 2.5</span>
                </div>
            </div>
        );

        const QuizScreen = ({ question, questionNumber, totalQuestions, onAnswer, feedback, onRestart, onReport, isReported }) => {
            const progress = (questionNumber / totalQuestions) * 100;
            const getButtonStyles = (letter) => {
                const baseStyles = "w-full p-4 rounded-xl text-left text-lg border-2 transition-all duration-300 flex items-center group relative overflow-hidden";
                if (!feedback) return `${baseStyles} bg-slate-800 border-slate-700 hover:border-cyan-500 hover:bg-slate-750 text-slate-200`;
                if (letter === question.answer) return `${baseStyles} bg-green-900/20 border-green-500 text-green-100 shadow-[0_0_15px_rgba(34,197,94,0.2)]`;
                if (letter === feedback.selected) return `${baseStyles} bg-red-900/20 border-red-500 text-red-100`;
                return `${baseStyles} bg-slate-900/50 border-slate-800 text-slate-500 opacity-50`;
            };

            return (
                <div className="w-full max-w-3xl mx-auto animate-fade-in">
                    <div className="mb-8 flex items-center justify-between bg-slate-800/50 p-4 rounded-xl border border-slate-700 backdrop-blur-sm">
                        <button onClick={onRestart} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-colors flex items-center gap-2" title="Về màn hình chính">
                            <Home className="w-5 h-5" />
                            <span className="hidden md:inline text-sm font-medium">Home</span>
                        </button>
                        <div className="flex-1 mx-6 flex flex-col gap-1">
                            <div className="flex justify-between text-xs text-slate-400 font-medium uppercase tracking-wider">
                                <span>Tiến độ</span>
                                <span>{questionNumber}/{totalQuestions}</span>
                            </div>
                            <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div className="h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500 ease-out rounded-full" style={{ width: `${progress}%` }} />
                            </div>
                        </div>
                    </div>

                    <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6 md:p-8 shadow-xl mb-6">
                        <h3 className="text-xl md:text-2xl font-semibold text-white leading-relaxed mb-8">{question.question}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {question.options.map((option, idx) => {
                                const letter = String.fromCharCode(65 + idx);
                                return (
                                    <button key={idx} onClick={() => onAnswer(letter)} disabled={!!feedback} className={getButtonStyles(letter)}>
                                        <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold mr-4 transition-colors ${feedback && letter === question.answer ? 'bg-green-500 text-white' : feedback && letter === feedback.selected ? 'bg-red-500 text-white' : 'bg-slate-700 text-slate-300 group-hover:bg-cyan-500 group-hover:text-white'}`}>{letter}</span>
                                        <span className="flex-1">{option}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {feedback && (
                        <div className={`transform transition-all duration-500 ease-out translate-y-0 opacity-100 rounded-xl p-6 border ${feedback.isCorrect ? 'bg-green-900/20 border-green-500/50' : 'bg-red-900/20 border-red-500/50'}`}>
                            <div className="flex items-start gap-4">
                                <div className={`p-2 rounded-full ${feedback.isCorrect ? 'bg-green-500/20' : 'bg-red-500/20'}`}>
                                    {feedback.isCorrect ? <CheckCircle className="w-6 h-6 text-green-400" /> : <XCircle className="w-6 h-6 text-red-400" />}
                                </div>
                                <div className="flex-1">
                                    <h4 className={`font-bold text-lg mb-1 ${feedback.isCorrect ? 'text-green-400' : 'text-red-400'}`}>{feedback.isCorrect ? "Chính xác!" : "Chưa đúng rồi..."}</h4>
                                    <p className="text-slate-300 leading-relaxed">{feedback.message}</p>
                                </div>
                                <button onClick={onReport} disabled={isReported} className={`p-2 rounded-lg transition-colors ${isReported ? 'text-yellow-500 bg-yellow-500/10 cursor-not-allowed' : 'text-slate-500 hover:text-yellow-400 hover:bg-slate-700'}`} title="Báo cáo câu hỏi lỗi">
                                    <Flag className={`w-5 h-5 ${isReported ? 'fill-current' : ''}`} />
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ResultsScreen = ({ score, totalQuestions, userAnswers, onRestart, onReport }) => {
            const percentage = Math.round((score / totalQuestions) * 100);
            const getMessage = () => {
                if (percentage === 100) return { text: "Xuất Sắc! Tuyệt đối!", color: "text-yellow-400" };
                if (percentage >= 80) return { text: "Làm rất tốt!", color: "text-green-400" };
                if (percentage >= 50) return { text: "Đạt yêu cầu, cố lên!", color: "text-cyan-400" };
                return { text: "Cần ôn tập thêm nhé!", color: "text-red-400" };
            };
            const message = getMessage();

            return (
                <div className="w-full max-w-4xl mx-auto animate-fade-in">
                    <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-8 text-center mb-8 shadow-xl relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-b from-cyan-500/5 to-transparent pointer-events-none"></div>
                        <div className="bg-slate-900/50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-slate-700">
                            <Trophy className={`w-10 h-10 ${percentage >= 80 ? 'text-yellow-400' : 'text-slate-400'}`} />
                        </div>
                        <h2 className="text-3xl font-bold text-white mb-2">Kết Quả Bài Làm</h2>
                        <p className={`text-xl font-medium mb-6 ${message.color}`}>{message.text}</p>
                        <div className="flex justify-center items-baseline gap-2 mb-8">
                            <span className="text-6xl font-bold text-white">{score}</span>
                            <span className="text-2xl text-slate-500 font-medium">/ {totalQuestions}</span>
                        </div>
                        <button onClick={onRestart} className="inline-flex items-center gap-2 bg-cyan-600 hover:bg-cyan-500 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg shadow-cyan-500/20 transform hover:-translate-y-1">
                            <RotateCcw className="w-5 h-5" /> Làm Đề Mới
                        </button>
                    </div>
                    <div className="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden">
                        <div className="bg-slate-800/50 p-4 border-b border-slate-700 flex items-center gap-2">
                            <List className="w-5 h-5 text-cyan-400" /> <h3 className="font-bold text-white">Chi Tiết Bài Làm</h3>
                        </div>
                        <div className="divide-y divide-slate-800">
                            {userAnswers.map((ans, idx) => (
                                <div key={idx} className="p-6 hover:bg-slate-800/30 transition-colors">
                                    <div className="flex items-start gap-4">
                                        <span className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm mt-1 ${ans.isCorrect ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>{idx + 1}</span>
                                        <div className="flex-1">
                                            <p className="text-slate-200 font-medium text-lg mb-3">{ans.questionText}</p>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                                                <div className={`p-3 rounded-lg border ${ans.isCorrect ? 'bg-green-900/10 border-green-500/30 text-green-300' : 'bg-red-900/10 border-red-500/30 text-red-300'}`}>
                                                    <span className="text-xs opacity-70 block mb-1">Bạn chọn:</span>
                                                    <div className="flex items-center gap-2 font-bold">
                                                        {ans.isCorrect ? <CheckCircle2 className="w-4 h-4" /> : <XCircle className="w-4 h-4" />}
                                                        {ans.selectedOptionLetter}. {ans.options[ans.selectedOptionLetter.charCodeAt(0) - 65]}
                                                    </div>
                                                </div>
                                                {!ans.isCorrect && (
                                                    <div className="p-3 rounded-lg bg-slate-800 border border-slate-700 text-slate-300">
                                                        <span className="text-xs opacity-70 block mb-1">Đáp án đúng:</span>
                                                        <div className="flex items-center gap-2 font-bold text-green-400">
                                                            <CheckCircle2 className="w-4 h-4" />
                                                            {ans.correctOptionLetter}. {ans.options[ans.correctOptionLetter.charCodeAt(0) - 65]}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50">
                                                <div className="flex justify-between items-start gap-4">
                                                    <div>
                                                        <span className="text-xs text-cyan-400 uppercase font-bold tracking-wider mb-1 block">Giải Thích</span>
                                                        <p className="text-slate-300 text-sm leading-relaxed">{ans.feedback}</p>
                                                    </div>
                                                    <button onClick={() => onReport(idx)} disabled={ans.reported} className={`p-1.5 rounded transition-colors ${ans.reported ? 'text-yellow-500 cursor-not-allowed' : 'text-slate-600 hover:text-yellow-400 hover:bg-slate-700'}`} title="Báo cáo giải thích này">
                                                        <Flag className={`w-4 h-4 ${ans.reported ? 'fill-current' : ''}`} />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP ---
        function App() {
            const [gameState, setGameState] = useState(GameState.START);
            const [questions, setQuestions] = useState([]);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            const [score, setScore] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [error, setError] = useState(null);

            const handleStartQuiz = useCallback(async (topic, count, apiKey) => {
                setGameState(GameState.LOADING);
                setError(null);
                try {
                    const data = await generateQuizQuestions(topic, count, apiKey);
                    if (data.questions && data.questions.length > 0) {
                        setQuestions(data.questions);
                        setGameState(GameState.QUIZ);
                        setCurrentQuestionIndex(0);
                        setUserAnswers([]);
                        setScore(0);
                        setFeedback(null);
                    } else {
                        throw new Error("Received empty question set");
                    }
                } catch (err) {
                    setError(err.message || "Failed to generate questions");
                    setGameState(GameState.START);
                }
            }, []);

            const handleAnswer = (selectedOption) => {
                if (feedback) return;
                const currentQuestion = questions[currentQuestionIndex];
                const isCorrect = selectedOption === currentQuestion.answer;
                const answerRecord = {
                    questionText: currentQuestion.question,
                    options: currentQuestion.options,
                    selectedOptionLetter: selectedOption,
                    correctOptionLetter: currentQuestion.answer,
                    isCorrect: isCorrect,
                    feedback: currentQuestion.feedback,
                    reported: false,
                };
                setUserAnswers(prev => [...prev, answerRecord]);
                if (isCorrect) setScore(prev => prev + 1);
                setFeedback({ isCorrect, selected: selectedOption, message: currentQuestion.feedback });
                setTimeout(() => {
                    if (currentQuestionIndex < questions.length - 1) {
                        setCurrentQuestionIndex(prev => prev + 1);
                        setFeedback(null);
                    } else {
                        setGameState(GameState.RESULTS);
                    }
                }, 3500);
            };

            const handleReport = (index) => {
                setUserAnswers(prev => {
                    const next = [...prev];
                    const targetIndex = index !== undefined ? index : currentQuestionIndex;
                    if (next[targetIndex]) next[targetIndex].reported = true;
                    return next;
                });
                alert("Đã báo cáo nội dung. Cảm ơn đóng góp của bạn!");
            };

            const handleRestart = () => {
                setGameState(GameState.START);
                setQuestions([]);
                setFeedback(null);
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-200 flex flex-col">
                    <header className="py-6 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 sticky top-0 z-50">
                        <div className="container mx-auto px-4 flex justify-center">
                            <div className="text-center">
                                <h1 className="text-2xl md:text-3xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">Grammar Master AI</h1>
                                <p className="text-lg font-medium text-cyan-400 mt-1">by Mr. Anh Đinh</p>
                                <p className="text-xs text-slate-500 tracking-widest uppercase mt-1">Tuyển Sinh 10 Prep</p>
                            </div>
                        </div>
                    </header>
                    <main className="flex-1 container mx-auto px-4 py-8 flex flex-col items-center justify-center">
                        {gameState === GameState.START && <StartScreen onStart={handleStartQuiz} error={error} />}
                        {gameState === GameState.LOADING && <LoadingScreen />}
                        {gameState === GameState.QUIZ && questions.length > 0 && (
                            <QuizScreen 
                                question={questions[currentQuestionIndex]}
                                questionNumber={currentQuestionIndex + 1}
                                totalQuestions={questions.length}
                                onAnswer={handleAnswer}
                                feedback={feedback}
                                onRestart={handleRestart}
                                onReport={() => handleReport()}
                                isReported={userAnswers[currentQuestionIndex]?.reported || false}
                            />
                        )}
                        {gameState === GameState.RESULTS && (
                            <ResultsScreen score={score} totalQuestions={questions.length} userAnswers={userAnswers} onRestart={handleRestart} onReport={handleReport} />
                        )}
                    </main>
                    <footer className="py-6 text-center text-slate-600 text-sm">
                        <p>© 2025 AI Grammar Practice. Designed for Student Success.</p>
                    </footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
